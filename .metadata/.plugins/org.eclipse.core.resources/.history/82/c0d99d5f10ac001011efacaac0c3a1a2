package com.example.githubactivity.service;

import java.util.Arrays;
import java.util.Collections;
import java.util.List;
import java.util.Map;
import java.util.concurrent.ConcurrentHashMap;
import java.util.stream.Collectors;

import org.springframework.cache.annotation.Cacheable;
import org.springframework.http.ResponseEntity;
import org.springframework.stereotype.Service;
import org.springframework.web.client.RestClientResponseException;
import org.springframework.web.client.RestTemplate;

import com.example.githubactivity.dto.ActivityResponse;
import com.example.githubactivity.exception.GithubUserNotFoundException;
import com.example.githubactivity.model.Event;

@Service
public class GithubService {
	
	private final RestTemplate restTemplate = new RestTemplate();
	
	// Simple rate-limiting: track last request time per username
	private final Map<String, Long> lastRequestTime = new ConcurrentHashMap<>();
	private static final long RATE_LIMIT_INTERVAL_MS = 2000; // 2 seconds between API calls per user
	
	@Cacheable(value = "githubActivity", key = "#userName + '_' + #page + '_' + #perPage") // Cache results by userName
	public List<Event> getRawActivity(String userName, int page, int perPage) {
		enforceRateLimit(userName);
		
		String url = "https://api.github.com/users/" + userName + "/events?page=" + page + "&per_page" + perPage;
		System.out.println("Fetching from GitHub API for " + userName + " page " + page);
		
		try {
			ResponseEntity<Event[]> response = restTemplate.getForEntity(url, Event[].class);
			Event[] events = response.getBody();
			return Arrays.asList(events);
		} catch (RestClientResponseException ex) {
			if (ex.getRawStatusCode() == 404) {
				throw new GithubUserNotFoundException("The Github user '" + userName + "' does not exist.");
			} else {
				throw new RuntimeException("Github API error: " + ex.getRawStatusCode());
			}
		}
	}
	
	private void enforceRateLimit(String userName) {
		long currentTime = System.currentTimeMillis();
		Long lastTime = lastRequestTime.get(userName);
		
		if (lastTime != null && (currentTime - lastTime < RATE_LIMIT_INTERVAL_MS)) {
			throw new RuntimeException("Too many requests for '" + userName + "'. Please wait a moment.");
		}
		
		lastRequestTime.put(userName, currentTime);
	}
	
	public List<ActivityResponse> fetchUserActivity(String userName, String type, int page, int perPage) {
		List<Event> events = getRawActivity(userName, page, perPage);
		
		// Optional filtering by event type
		if (type != null && !type.isEmpty()) {
			events = events.stream()
					.filter(e -> e.getType() != null && e.getType().equalsIgnoreCase(type))
					.collect(Collectors.toList());
		}
		
		// Convert to structured, readable format
		return events.stream()
				.map(this::mapToActivityResponse)
				.collect(Collectors.toList());
	}
	
	private ActivityResponse mapToActivityResponse(Event event) {
		String eventType = event.getType();
		String repoName = event.getRepo() != null ? event.getRepo().getName() : "Unknown Repo";
		String createdAt = event.getCreated_at();
		
		String description = generateDescription(eventType, repoName);
		return new ActivityResponse(description, repoName, eventType, createdAt);
	}
	
	private String generateDescription(String eventType, String repoName) {
		return switch (eventType) {
		case "PushEvent" -> "Pushed new commits to " + repoName;
		case "CreateEvent" -> "Created repository or branch in " + repoName;
		case "WatchEvent" -> "Starred " + repoName;
		case "IssuesEvent" -> "Interacted with issues in " + repoName;
		case "ForkEvent" -> "Forked " + repoName;
		default -> "Performed " + eventType + "in " + repoName;
		};
	}
}